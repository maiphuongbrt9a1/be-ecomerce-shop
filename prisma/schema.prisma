// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

// Looking for ways to speed up your queries, or scale easily with your serverless or edge functions?
// Try Prisma Accelerate: https://pris.ly/cli/accelerate-init

generator client {
provider = "prisma-client-js"
}

datasource db {
provider = "postgresql"
url      = env("DATABASE_URL")
}

enum Role {
    USER
    ADMIN
    OPERATOR
}

enum Gender {
    MALE
    FEMALE
    OTHER
}

enum MediaType {
    IMAGE
    VIDEO
    DOCUMENT
}

enum OrderStatus {
    PENDING
    PROCESSING
    SHIPPED
    DELIVERED
    CANCELLED
    RETURNED
}

enum ShipmentStatus {
    WAITING_FOR_PICKUP
    IN_TRANSIT
    OUT_FOR_DELIVERY
    DELIVERED
    DELIVERED_FAILED
    RETURNED_TO_SENDER
}

enum PaymentStatus {
    PENDING
    PAID
    FAILED
    REFUNDED
}

enum VoucherStatus {
    AVAILABLE
    SAVED
    USED
    EXPIRED
}

enum DiscountType {
    PERCENTAGE
    FIXED_AMOUNT
}

enum RequestStatus {
    PENDING
    IN_PROGRESS
    APPROVED
    REJECTED
}

model User {
    // Base user fields
    id          BigInt      @db.BigInt @id @default(autoincrement())
    firstName   String?     @db.VarChar(255)
    lastName    String?     @db.VarChar(255)
    gender      Gender?     @default(OTHER)
    email       String      @unique
    phone       String?     @db.VarChar(10)
    username    String      @unique @db.VarChar(32)
    password    String 
    role        Role        @default(USER)
    isActive    Boolean     @default(false)
    codeActive  String      @db.Uuid
    codeActiveExpire DateTime
    points      Int         @default(0)
    createdAt   DateTime    @default(now())
    updatedAt   DateTime    @updatedAt
    
    // base relations of user
    address   Address[]
    userMedia   Media[]
    
    // Staff fields if user is staff
    staffCode   String?      @unique @db.VarChar(50)
    isAdmin     Boolean     @default(false)

    // relations of staff
    vouchers    Vouchers[]
    products   Products[]
    OrdersProcessedByStaff Orders[] @relation("OrderProcessedByStaff")
    OrdersShippedByStaff  Shipments[] @relation("OrderShippedByStaff")
    CategoryCreatedByUser Category[] @relation("CategoryCreatedByUser")
    ProductVariantsCreatedByUser ProductVariants[] @relation("ProductVariantCreatedByUser")
    RequestsProcessedByStaff Requests[] @relation("RequestsProcessedByStaff")
    shopOffice ShopOffice? @relation(fields: [shopOfficeId], references: [id], onDelete: SetNull, onUpdate: Cascade)
    shopOfficeId BigInt?

    // Customer fields if user is customer
    loyaltyCard String?     @db.VarChar(50)

    // relations of customer
    sizeProfiles SizeProfiles[]
    reviews     Reviews[]
    orders      Orders[]
    cart        Cart?
    userVouchers UserVouchers[]
    requests    Requests[]

}

model ShopOffice {
    id BigInt @db.BigInt @id @default(autoincrement())
    staffs User[]
    address Address?
    products Products[]
    category Category[]

}

model Address {
    id          BigInt      @db.BigInt @id @default(autoincrement())
    user        User?     @relation(fields: [userId], references: [id], onDelete: Cascade, onUpdate: Cascade)
    userId      BigInt?      @db.BigInt
    street      String      @db.VarChar(255)
    ward       String      @db.VarChar(100)
    district        String      @db.VarChar(100)
    province       String      @db.VarChar(100)
    zipCode     String      @db.VarChar(20)
    country     String      @db.VarChar(100)
    createdAt   DateTime    @default(now())
    updatedAt   DateTime    @updatedAt
    order       Orders[]
    shopOffice ShopOffice? @relation(fields: [shopOfficeId], references: [id], onDelete: Cascade, onUpdate: Cascade)
    shopOfficeId BigInt? @unique
}

model SizeProfiles {
    id          BigInt      @db.BigInt @id @default(autoincrement())
    user    User    @relation(fields: [userId], references: [id], onDelete: Cascade, onUpdate: Cascade)
    userId      BigInt      @db.BigInt
    heightCm      Float?
    weightKg      Float?
    chestCm       Float?
    hipCm       Float?
    sleeveLengthCm Float?
    inseamCm      Float?
    shoulderLengthCm Float?
    bodyType    String?     @db.VarChar(100)
    description String?     @db.Text
    createdAt   DateTime    @default(now())
    updatedAt   DateTime    @updatedAt
}

model Products {
    id          BigInt      @db.BigInt @id @default(autoincrement())
    name        String      @db.VarChar(255)
    description String?     @db.Text
    price       Float
    stockKeepingUnit         String      @unique @db.VarChar(100)
    stock       Int         @default(0)
    category    Category?    @relation(fields: [categoryId], references: [id], onDelete: SetNull, onUpdate: Cascade)
    categoryId    BigInt?      @db.BigInt
    createByUser        User        @relation(fields: [createByUserId], references: [id], onDelete: Restrict, onUpdate: Cascade)
    createByUserId      BigInt      @db.BigInt
    createdAt   DateTime    @default(now())
    updatedAt   DateTime    @updatedAt
    productVariants    ProductVariants[]
    reviews     Reviews[]
    voucher Vouchers? @relation(fields: [voucherId], references: [id], onDelete: SetNull, onUpdate: Cascade)
    voucherId BigInt?
    shopOffice ShopOffice? @relation(fields: [shopOfficeId], references: [id], onDelete: SetNull, onUpdate: Cascade)
    shopOfficeId BigInt?

}

model Category {
    id          BigInt      @db.BigInt @id @default(autoincrement())
    name        String      @unique @db.VarChar(100)
    description String?     @db.Text
    products    Products[]
    subCategories Category[]  @relation("CategoryToCategory")
    
    categoryParent Category?   @relation("CategoryToCategory", fields: [parentId], references: [id], onDelete: SetNull, onUpdate: Cascade)
    parentId    BigInt?     @db.BigInt
    
    createByUser        User        @relation("CategoryCreatedByUser", fields: [createByUserId], references: [id], onDelete: Restrict, onUpdate: Cascade)
    createByUserId      BigInt      @db.BigInt
    
    voucher Vouchers? @relation(fields: [voucherId], references: [id], onDelete: SetNull, onUpdate: Cascade)
    voucherId BigInt?
    
    shopOffice ShopOffice? @relation(fields: [shopOfficeId], references: [id], onDelete: SetNull, onUpdate: Cascade)
    shopOfficeId BigInt?

    createdAt   DateTime    @default(now())
    updatedAt   DateTime    @updatedAt
}

model ProductVariants {
    id          BigInt      @db.BigInt @id @default(autoincrement())
    product     Products    @relation(fields: [productId], references: [id], onDelete: Cascade, onUpdate: Cascade)
    productId   BigInt      @db.BigInt
    orderItem   OrderItems?
    createByUser        User        @relation("ProductVariantCreatedByUser", fields: [createByUserId], references: [id], onDelete: Restrict, onUpdate: Cascade)
    createByUserId      BigInt      @db.BigInt
    
    variantName String      @db.VarChar(100)
    variantColor String     @db.VarChar(100)
    variantSize String     @db.VarChar(100)
    price Float   @default(0)
    stock       Int         @default(0)
    stockKeepingUnit         String      @unique @db.VarChar(100)
    createdAt   DateTime    @default(now())
    updatedAt   DateTime    @updatedAt
    reviews     Reviews[]
    media       Media[]
    cartItems   CartItems[]
    
    voucher Vouchers? @relation(fields: [voucherId], references: [id], onDelete: SetNull, onUpdate: Cascade)
    voucherId BigInt? 
}

model Reviews {
    id          BigInt      @db.BigInt @id @default(autoincrement())
    product     Products    @relation(fields: [productId], references: [id], onDelete: Cascade, onUpdate: Cascade)
    productId   BigInt      @db.BigInt
    user    User    @relation(fields: [userId], references: [id], onDelete: Restrict, onUpdate: Cascade)
    userId  BigInt      @db.BigInt
    productVariant ProductVariants @relation(fields: [productVariantId], references: [id], onDelete: Cascade, onUpdate: Cascade)
    productVariantId BigInt  @db.BigInt
    rating      Int
    comment     String?     @db.Text
    media       Media[]
    createdAt   DateTime    @default(now())
    updatedAt   DateTime    @updatedAt
}

model Media {
    id          BigInt      @db.BigInt @id @default(autoincrement())
    url         String      @db.Text @unique
    type        MediaType      @default(IMAGE)
    review      Reviews?     @relation(fields: [reviewId], references: [id], onDelete: Cascade, onUpdate: Cascade)
    reviewId    BigInt?      @db.BigInt
    user        User?        @relation(fields: [userId], references: [id], onDelete: Cascade, onUpdate: Cascade)
    userId      BigInt?      @db.BigInt
    productVariant ProductVariants? @relation(fields: [productVariantId], references: [id], onDelete: Cascade, onUpdate: Cascade)
    productVariantId BigInt?  @db.BigInt
    createdAt   DateTime    @default(now())
    updatedAt   DateTime    @updatedAt
}

model Orders {
    id          BigInt      @db.BigInt @id @default(autoincrement())
    user    User    @relation(fields: [userId], references: [id], onDelete: Restrict, onUpdate: Cascade)
    shippingAddress Address @relation(fields: [shippingAddressId], references: [id], onDelete: Restrict, onUpdate: Cascade)
    shippingAddressId BigInt  @db.BigInt
    userId  BigInt      @db.BigInt
    processByStaff        User        @relation("OrderProcessedByStaff", fields: [processByStaffId], references: [id], onDelete: Restrict, onUpdate: Cascade)
    processByStaffId      BigInt      @db.BigInt 
    
    orderDate   DateTime    @default(now())
    status      OrderStatus      @default(PENDING)
    subTotal    Float
    shippingFee Float
    discount    Float       @default(0)
    totalAmount Float
    createdAt   DateTime    @default(now())
    updatedAt   DateTime    @updatedAt
    orderItems  OrderItems[]
    shipments   Shipments[]
    payment     Payments?
    requests Requests[]
}


model OrderItems {
    id          BigInt      @db.BigInt @id @default(autoincrement())
    order       Orders      @relation(fields: [orderId], references: [id], onDelete: Restrict, onUpdate: Cascade)
    orderId     BigInt      @db.BigInt
    productVariant ProductVariants @relation(fields: [productVariantId], references: [id], onDelete: Restrict, onUpdate: Cascade)
    productVariantId BigInt  @db.BigInt @unique
    quantity    Int
    unitPrice   Float
    totalPrice  Float
    createdAt   DateTime    @default(now())
    updatedAt   DateTime    @updatedAt
}

model Shipments {
    id          BigInt      @db.BigInt @id @default(autoincrement())
    order       Orders      @relation(fields: [orderId], references: [id], onDelete: Restrict, onUpdate: Cascade)
    orderId     BigInt      @db.BigInt @unique
    processByStaff        User        @relation("OrderShippedByStaff", fields: [processByStaffId], references: [id], onDelete: Restrict, onUpdate: Cascade)
    processByStaffId      BigInt      @db.BigInt
    
    estimatedDelivery DateTime
    deliveredAt DateTime?
    estimatedShipDate DateTime
    shippedAt   DateTime?
    carrier     String      @db.VarChar(100)
    trackingNumber String   @unique @db.VarChar(100)
    status      ShipmentStatus      @default(WAITING_FOR_PICKUP)
    createdAt   DateTime    @default(now())
    updatedAt   DateTime    @updatedAt
}

model Payments {
    id          BigInt      @db.BigInt @id @default(autoincrement())
    order       Orders      @relation(fields: [orderId], references: [id], onDelete: Restrict, onUpdate: Cascade)
    orderId     BigInt      @db.BigInt @unique
    transactionId String    @unique @db.VarChar(100)
    paymentMethod String    @db.VarChar(100)
    paymentDate DateTime    @default(now())
    amount      Float
    status      PaymentStatus      @default(PENDING)
}

model Cart {
    id          BigInt      @db.BigInt @id @default(autoincrement())
    user    User    @relation(fields: [userId], references: [id], onDelete: Cascade, onUpdate: Cascade)
    userId  BigInt      @db.BigInt @unique
    cartItems   CartItems[]
    createdAt   DateTime    @default(now())
    updatedAt   DateTime    @updatedAt
}

model CartItems {
    id          BigInt      @db.BigInt @id @default(autoincrement())
    cart        Cart        @relation(fields: [cartId], references: [id], onDelete: Cascade, onUpdate: Cascade)
    cartId      BigInt      @db.BigInt
    productVariant ProductVariants @relation(fields: [productVariantId], references: [id], onDelete: Cascade, onUpdate: Cascade)
    productVariantId BigInt  @db.BigInt
    quantity    Int
    createdAt   DateTime    @default(now())
    updatedAt   DateTime    @updatedAt
}

model Vouchers {
    id          BigInt      @db.BigInt @id @default(autoincrement())
    code        String      @unique @db.VarChar(50)
    description String?     @db.Text
    discountType DiscountType     @default(FIXED_AMOUNT)
    discountValue Float
    validFrom   DateTime
    validTo     DateTime
    usageLimit  Int?
    timesUsed   Int         @default(0)
    isActive    Boolean     @default(true)
    createdAt   DateTime    @default(now())
    user        User        @relation(fields: [createdBy], references: [id], onDelete: Restrict, onUpdate: Cascade)
    createdBy   BigInt     @db.BigInt
    updatedAt   DateTime    @updatedAt
    userVouchers UserVouchers[]
    voucherForProduct Products[]
    voucherForCategory Category[]
    voucherForSpecialProductVariant ProductVariants[]
}

model UserVouchers {
    id          BigInt      @db.BigInt @id @default(autoincrement())
    user        User        @relation(fields: [userId], references: [id], onDelete: Cascade, onUpdate: Cascade)
    userId      BigInt      @db.BigInt
    voucher     Vouchers    @relation(fields: [voucherId], references: [id], onDelete: Cascade, onUpdate: Cascade)
    voucherId   BigInt      @db.BigInt
    useVoucherAt  DateTime?
    saveVoucherAt   DateTime    @default(now())
    voucherStatus VoucherStatus      @default(SAVED)
}

model Requests {
    id          BigInt      @db.BigInt @id @default(autoincrement())
    user        User        @relation(fields: [userId], references: [id], onDelete: Restrict, onUpdate: Cascade)
    userId      BigInt      @db.BigInt
    processByStaff        User        @relation("RequestsProcessedByStaff", fields: [processByStaffId], references: [id], onDelete: Restrict, onUpdate: Cascade)
    processByStaffId      BigInt      @db.BigInt
    order       Orders      @relation(fields: [orderId], references: [id], onDelete: Restrict, onUpdate: Cascade)
    orderId     BigInt      @db.BigInt @unique
    subject     String      @db.VarChar(255)
    description String      @db.Text
    status      RequestStatus      @default(PENDING)
    createdAt   DateTime    @default(now())
    updatedAt   DateTime    @updatedAt
    returnRequest ReturnRequests[]
}

model ReturnRequests {
    id          BigInt      @db.BigInt @id @default(autoincrement())
    request     Requests    @relation(fields: [requestId], references: [id], onDelete: Restrict, onUpdate: Cascade)
    requestId   BigInt      @db.BigInt @unique
    createdAt   DateTime    @default(now())
    updatedAt   DateTime    @updatedAt
}
