// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

// Looking for ways to speed up your queries, or scale easily with your serverless or edge functions?
// Try Prisma Accelerate: https://pris.ly/cli/accelerate-init

generator client {
provider = "prisma-client-js"
}

datasource db {
provider = "postgresql"
url      = env("DATABASE_URL")
}

/* DEFINE ROLES:
    USER ROLE IS CUSTOMER, 
    ADMIN ROLE IS ADMIN, 
    OPERATOR ROLE IS STAFF
*/
enum Role {
    USER
    ADMIN
    OPERATOR
}

enum Gender {
    MALE
    FEMALE
    OTHER
}

enum MediaType {
    IMAGE
    VIDEO
    DOCUMENT
}

enum OrderStatus {
    PENDING
    PROCESSING
    SHIPPED
    DELIVERED
    CANCELLED
    RETURNED
}

enum ShipmentStatus {
    WAITING_FOR_PICKUP
    IN_TRANSIT
    OUT_FOR_DELIVERY
    DELIVERED
    DELIVERED_FAILED
    RETURNED_TO_SENDER
}

enum PaymentStatus {
    PENDING
    PAID
    FAILED
    REFUNDED
}

enum PaymentMethod {
    COD
    VNPAY
    MOMO
    ZALOPAY
    CREDIT_CARD
    BANK_TRANSFER
}

enum VoucherStatus {
    AVAILABLE
    SAVED
    USED
    EXPIRED
}

enum DiscountType {
    PERCENTAGE
    FIXED_AMOUNT
}

enum RequestStatus {
    PENDING
    IN_PROGRESS
    APPROVED
    REJECTED
}

model User {
    // Base user fields
    id          BigInt      @db.BigInt @id @default(autoincrement())
    firstName   String?     @db.VarChar(255)
    lastName    String?     @db.VarChar(255)
    gender      Gender?     @default(OTHER)
    email       String      @unique
    phone       String?     @db.VarChar(10)
    username    String      @unique @db.VarChar(32)
    password    String?
    googleId    String?     @unique @db.VarChar(255)
    role        Role        @default(USER)
    isActive    Boolean     @default(false) @db.Boolean
    codeActive  String      @db.Uuid
    codeActiveExpire DateTime
    points      Int         @default(0) @db.Integer
    createdAt   DateTime    @default(now())
    updatedAt   DateTime    @updatedAt
    
    // base relations of user
    address   Address[]
    userMedia   Media[]
    
    // Staff fields if user is staff
    staffCode   String?      @unique @db.VarChar(50)
    

    // relations of staff
    vouchers    Vouchers[]
    products   Products[]
    OrdersProcessedByStaff Orders[] @relation("OrderProcessedByStaff")
    OrdersShippedByStaff  Shipments[] @relation("OrderShippedByStaff")
    CategoryCreatedByUser Category[] @relation("CategoryCreatedByUser")
    ProductVariantsCreatedByUser ProductVariants[] @relation("ProductVariantCreatedByUser")
    RequestsProcessedByStaff Requests[] @relation("RequestsProcessedByStaff")
    shopOffice ShopOffice? @relation(fields: [shopOfficeId], references: [id], onDelete: SetNull, onUpdate: Cascade)
    shopOfficeId BigInt?    @db.BigInt

    // Customer fields if user is customer
    loyaltyCard String?     @db.VarChar(50)

    // relations of customer
    sizeProfiles SizeProfiles[]
    reviews     Reviews[]
    orders      Orders[]
    cart        Cart?
    userVouchers UserVouchers[]
    requests    Requests[]

    @@index([shopOfficeId], name: "idx_user_shop_office_id")

}

model ShopOffice {
    id BigInt @db.BigInt @id @default(autoincrement())
    ghnShopId BigInt? @db.BigInt @unique
    shopName String @db.VarChar(255)
    staffs User[]
    address Address?
    products Products[]
    category Category[]
    shipments Shipments[]
    createdAt   DateTime    @default(now())
    updatedAt   DateTime    @updatedAt

}

model Address {
    id          BigInt      @db.BigInt @id @default(autoincrement())
    user        User?     @relation(fields: [userId], references: [id], onDelete: Cascade, onUpdate: Cascade)
    userId      BigInt?      @db.BigInt
    street      String      @db.VarChar(255)
    ward       String      @db.VarChar(100)
    district        String      @db.VarChar(100)
    province       String      @db.VarChar(100)
    zipCode     String      @db.VarChar(20)
    country     String      @db.VarChar(100)
    createdAt   DateTime    @default(now())
    updatedAt   DateTime    @updatedAt
    order       Orders[]
    shopOffice ShopOffice? @relation(fields: [shopOfficeId], references: [id], onDelete: Cascade, onUpdate: Cascade)
    shopOfficeId BigInt? @unique @db.BigInt
    @@index([userId], name: "idx_address_user_id")
    @@index([shopOfficeId], name: "idx_address_shop_office_id")
}

model SizeProfiles {
    id          BigInt      @db.BigInt @id @default(autoincrement())
    user    User    @relation(fields: [userId], references: [id], onDelete: Cascade, onUpdate: Cascade)
    userId      BigInt      @db.BigInt
    heightCm      Float?    @db.DoublePrecision @default(0) // in cm
    weightKg      Float?    @db.DoublePrecision @default(0) // in cm
    chestCm       Float?    @db.DoublePrecision @default(0) // in cm
    hipCm       Float?    @db.DoublePrecision @default(0) // in cm
    sleeveLengthCm Float?    @db.DoublePrecision @default(0) // in cm
    inseamCm      Float?    @db.DoublePrecision @default(0) // in cm
    shoulderLengthCm Float?    @db.DoublePrecision @default(0) // in cm
    bodyType    String?     @db.VarChar(100)
    description String?     @db.Text
    createdAt   DateTime    @default(now())
    updatedAt   DateTime    @updatedAt

    @@index([userId], name: "idx_sizeProfile_user_id")
}

model Products {
    id          BigInt      @db.BigInt @id @default(autoincrement())
    name        String      @db.VarChar(255)
    description String?     @db.Text
    price       Float       @db.DoublePrecision
    currencyUnit String      @db.VarChar(10) @default("VND")
    stockKeepingUnit         String      @unique @db.VarChar(100)
    stock       Int          @db.Integer
    category    Category?    @relation(fields: [categoryId], references: [id], onDelete: SetNull, onUpdate: Cascade)
    categoryId    BigInt?      @db.BigInt
    createByUser        User        @relation(fields: [createByUserId], references: [id], onDelete: Restrict, onUpdate: Cascade)
    createByUserId      BigInt      @db.BigInt
    createdAt   DateTime    @default(now())
    updatedAt   DateTime    @updatedAt
    productVariants    ProductVariants[]
    reviews     Reviews[]
    voucher Vouchers? @relation(fields: [voucherId], references: [id], onDelete: SetNull, onUpdate: Cascade)
    voucherId BigInt? @db.BigInt
    shopOffice ShopOffice? @relation(fields: [shopOfficeId], references: [id], onDelete: SetNull, onUpdate: Cascade)
    shopOfficeId BigInt? @db.BigInt

    @@index([categoryId], name: "idx_product_category_id")
    @@index([shopOfficeId], name: "idx_product_shop_office_id")
    @@index([voucherId], name: "idx_product_voucher_id")
    @@index([createByUserId], name: "idx_product_created_by_user_id")
}

model Category {
    id          BigInt      @db.BigInt @id @default(autoincrement())
    name        String      @unique @db.VarChar(100)
    description String?     @db.Text
    products    Products[]
    subCategories Category[]  @relation("CategoryToCategory")
    
    categoryParent Category?   @relation("CategoryToCategory", fields: [parentId], references: [id], onDelete: SetNull, onUpdate: Cascade)
    parentId    BigInt?     @db.BigInt
    
    createByUser        User        @relation("CategoryCreatedByUser", fields: [createByUserId], references: [id], onDelete: Restrict, onUpdate: Cascade)
    createByUserId      BigInt      @db.BigInt
    
    voucher Vouchers? @relation(fields: [voucherId], references: [id], onDelete: SetNull, onUpdate: Cascade)
    voucherId BigInt? @db.BigInt
    
    shopOffice ShopOffice? @relation(fields: [shopOfficeId], references: [id], onDelete: SetNull, onUpdate: Cascade)
    shopOfficeId BigInt? @db.BigInt

    createdAt   DateTime    @default(now())
    updatedAt   DateTime    @updatedAt

    @@index([parentId], name: "idx_category_parent_id")
    @@index([shopOfficeId], name: "idx_category_shop_office_id")
    @@index([voucherId], name: "idx_category_voucher_id")
    @@index([createByUserId], name: "idx_category_created_by_user_id")
}

model ProductVariants {
    id          BigInt      @db.BigInt @id @default(autoincrement())
    product     Products    @relation(fields: [productId], references: [id], onDelete: Cascade, onUpdate: Cascade)
    productId   BigInt      @db.BigInt
    orderItem   OrderItems[]
    createByUser        User        @relation("ProductVariantCreatedByUser", fields: [createByUserId], references: [id], onDelete: Restrict, onUpdate: Cascade)
    createByUserId      BigInt      @db.BigInt
    
    variantName String      @db.VarChar(100)
    variantColor String     @db.VarChar(100)
    variantSize String     @db.VarChar(100)
    variantWeight Float   @db.DoublePrecision @default(250) // in grams
    variantHeight Float   @db.DoublePrecision @default(5) // in cm 
    variantWidth  Float   @db.DoublePrecision @default(20) // in cm
    variantLength Float   @db.DoublePrecision @default(25) // in cm
    price Float      @db.DoublePrecision
    currencyUnit String      @db.VarChar(10) @default("VND")
    stock       Int          @db.Integer
    stockKeepingUnit         String      @unique @db.VarChar(100)
    createdAt   DateTime    @default(now())
    updatedAt   DateTime    @updatedAt
    reviews     Reviews[]
    media       Media[]
    cartItems   CartItems[]
    
    voucher Vouchers? @relation(fields: [voucherId], references: [id], onDelete: SetNull, onUpdate: Cascade)
    voucherId BigInt? @db.BigInt
    productVariantColor Color @relation(fields: [colorId], references: [id], onDelete: Restrict, onUpdate: Cascade)
    colorId BigInt @db.BigInt

    @@index([productId], name: "idx_productVariant_product_id")
    @@index([voucherId], name: "idx_productVariant_voucher_id")
    @@index([colorId], name: "idx_productVariant_color_id")
    @@index([createByUserId], name: "idx_productVariant_created_by_user_id")
}

model Color {
    id          BigInt      @db.BigInt @id @default(autoincrement())
    name        String      @unique @db.VarChar(100)
    hexCode     String      @db.VarChar(7)
    createdAt   DateTime    @default(now())
    updatedAt   DateTime    @updatedAt
    productVariants ProductVariants[]
}

model Reviews {
    id          BigInt      @db.BigInt @id @default(autoincrement())
    product     Products    @relation(fields: [productId], references: [id], onDelete: Cascade, onUpdate: Cascade)
    productId   BigInt      @db.BigInt
    user    User    @relation(fields: [userId], references: [id], onDelete: Restrict, onUpdate: Cascade)
    userId  BigInt      @db.BigInt
    productVariant ProductVariants @relation(fields: [productVariantId], references: [id], onDelete: Cascade, onUpdate: Cascade)
    productVariantId BigInt  @db.BigInt
    rating      Int     @db.Integer
    comment     String?     @db.Text
    media       Media[]
    createdAt   DateTime    @default(now())
    updatedAt   DateTime    @updatedAt

    @@index([productId], name: "idx_review_product_id")
    @@index([userId], name: "idx_review_user_id")
    @@index([productVariantId], name: "idx_review_product_variant_id")
}

model Media {
    id          BigInt      @db.BigInt @id @default(autoincrement())
    url         String      @db.Text @unique
    type        MediaType      @default(IMAGE)
    review      Reviews?     @relation(fields: [reviewId], references: [id], onDelete: Cascade, onUpdate: Cascade)
    reviewId    BigInt?      @db.BigInt
    user        User?        @relation(fields: [userId], references: [id], onDelete: Cascade, onUpdate: Cascade)
    userId      BigInt?      @db.BigInt
    productVariant ProductVariants? @relation(fields: [productVariantId], references: [id], onDelete: Cascade, onUpdate: Cascade)
    productVariantId BigInt?  @db.BigInt
    request        Requests?        @relation(fields: [requestId], references: [id], onDelete: Cascade, onUpdate: Cascade)
    requestId      BigInt?      @db.BigInt
    isShopLogo Boolean    @default(false) @db.Boolean
    isShopBanner Boolean   @default(false) @db.Boolean
    isCategoryFile Boolean @default(false) @db.Boolean
    isAvatarFile Boolean  @default(false) @db.Boolean
    createdAt   DateTime    @default(now())
    updatedAt   DateTime    @updatedAt

    @@index([reviewId], name: "idx_media_review_id")
    @@index([userId], name: "idx_media_user_id")
    @@index([productVariantId], name: "idx_media_product_variant_id")
    @@index([requestId], name: "idx_media_request_id")
}

model Orders {
    id          BigInt      @db.BigInt @id @default(autoincrement())
    user    User    @relation(fields: [userId], references: [id], onDelete: Restrict, onUpdate: Cascade)
    shippingAddress Address @relation(fields: [shippingAddressId], references: [id], onDelete: Restrict, onUpdate: Cascade)
    shippingAddressId BigInt  @db.BigInt
    userId  BigInt      @db.BigInt
    processByStaff        User?        @relation("OrderProcessedByStaff", fields: [processByStaffId], references: [id], onDelete: Restrict, onUpdate: Cascade)
    processByStaffId      BigInt?      @db.BigInt 
    
    orderDate   DateTime    @default(now())
    status      OrderStatus      @default(PENDING)
    subTotal    Float   @db.DoublePrecision  // total before shipping and discount
    shippingFee Float   @db.DoublePrecision  // shipping fee
    discount    Float       @db.DoublePrecision  // total discount amount
    totalAmount Float   @db.DoublePrecision  // total after shipping and discount
    currencyUnit String      @db.VarChar(10) @default("VND")
    createdAt   DateTime    @default(now())
    updatedAt   DateTime    @updatedAt
    orderItems  OrderItems[]
    shipments   Shipments[]
    payment     Payments[]
    requests Requests[]

    @@index([userId], name: "idx_order_user_id")
    @@index([shippingAddressId], name: "idx_order_shipping_address_id")
    @@index([processByStaffId], name: "idx_order_processed_by_staff_id")

}


model OrderItems {
    id          BigInt      @db.BigInt @id @default(autoincrement())
    order       Orders      @relation(fields: [orderId], references: [id], onDelete: Restrict, onUpdate: Cascade)
    orderId     BigInt      @db.BigInt
    productVariant ProductVariants @relation(fields: [productVariantId], references: [id], onDelete: Restrict, onUpdate: Cascade)
    productVariantId BigInt  @db.BigInt 
    quantity    Int     @db.Integer
    unitPrice   Float   @db.DoublePrecision 
    totalPrice  Float  @db.DoublePrecision // totalPrice = unitPrice * quantity
    discountValue Float   @db.DoublePrecision @default(0)// discount amount applied to this item
    currencyUnit String      @db.VarChar(10) @default("VND")
    createdAt   DateTime    @default(now())
    updatedAt   DateTime    @updatedAt
    shipmentItems ShipmentItems[]

    @@index([orderId], name: "idx_orderItem_order_id")
    @@index([productVariantId], name: "idx_orderItem_product_variant_id")
}

model Shipments {
    id          BigInt      @db.BigInt @id @default(autoincrement())
    order       Orders      @relation(fields: [orderId], references: [id], onDelete: Restrict, onUpdate: Cascade)
    orderId     BigInt      @db.BigInt
    processByStaff        User?        @relation("OrderShippedByStaff", fields: [processByStaffId], references: [id], onDelete: Restrict, onUpdate: Cascade)
    processByStaffId      BigInt?      @db.BigInt
    ghnOrderCode String? @db.VarChar(100) @unique
    shopOffice ShopOffice? @relation(fields: [shopOfficeId], references: [id], onDelete: SetNull, onUpdate: Cascade)
    shopOfficeId BigInt? @db.BigInt
    shipmentItems ShipmentItems[]    
    estimatedDelivery DateTime // at shop, estimate time when leave from shop
    deliveredAt DateTime?  // at shop, actual time when leave from shop
    estimatedShipDate DateTime // at customer, estimate time when arrive to customer
    shippedAt   DateTime?  // at customer, actual time when arrive to customer
    carrier     String      @db.VarChar(100)
    trackingNumber String   @db.VarChar(100)
    status      ShipmentStatus      @default(WAITING_FOR_PICKUP)
    createdAt   DateTime    @default(now())
    updatedAt   DateTime    @updatedAt

    @@index([orderId], name: "idx_shipment_order_id")
    @@index([processByStaffId], name: "idx_shipment_processed_by_staff_id")
}

model ShipmentItems {
    id          BigInt      @db.BigInt @id @default(autoincrement())
    shipment    Shipments   @relation(fields: [shipmentId], references: [id], onDelete: Restrict, onUpdate: Cascade)
    shipmentId  BigInt      @db.BigInt
    orderItem   OrderItems  @relation(fields: [orderItemId], references: [id], onDelete: Restrict, onUpdate: Cascade)
    orderItemId BigInt      @db.BigInt
    createdAt   DateTime    @default(now())
    updatedAt   DateTime    @updatedAt

    @@index([shipmentId], name: "idx_shipmentItem_shipment_id")
    @@index([orderItemId], name: "idx_shipmentItem_order_item_id")
}

model Payments {
    id          BigInt      @db.BigInt @id @default(autoincrement())
    order       Orders      @relation(fields: [orderId], references: [id], onDelete: Restrict, onUpdate: Cascade)
    orderId     BigInt      @db.BigInt
    transactionId String    @unique @db.VarChar(100)
    paymentMethod PaymentMethod    @default(COD)
    paymentDate DateTime    @default(now())
    amount      Float   @db.DoublePrecision 
    currencyUnit String      @db.VarChar(10) @default("VND")
    status      PaymentStatus      @default(PENDING)
    createdAt   DateTime    @default(now())
    updatedAt   DateTime    @updatedAt
    @@index([orderId], name: "idx_payment_order_id")
}

model Cart {
    id          BigInt      @db.BigInt @id @default(autoincrement())
    user    User    @relation(fields: [userId], references: [id], onDelete: Cascade, onUpdate: Cascade)
    userId  BigInt      @db.BigInt @unique
    cartItems   CartItems[]
    createdAt   DateTime    @default(now())
    updatedAt   DateTime    @updatedAt

    @@index([userId], name: "idx_cart_user_id")
}

model CartItems {
    id          BigInt      @db.BigInt @id @default(autoincrement())
    cart        Cart        @relation(fields: [cartId], references: [id], onDelete: Cascade, onUpdate: Cascade)
    cartId      BigInt      @db.BigInt
    productVariant ProductVariants @relation(fields: [productVariantId], references: [id], onDelete: Cascade, onUpdate: Cascade)
    productVariantId BigInt  @db.BigInt
    quantity    Int     @db.Integer
    createdAt   DateTime    @default(now())
    updatedAt   DateTime    @updatedAt

    @@index([cartId], name: "idx_cartItem_cart_id")
    @@index([productVariantId], name: "idx_cartItem_product_variant_id")
}

model Vouchers {
    id          BigInt      @db.BigInt @id @default(autoincrement())
    code        String      @unique @db.VarChar(50)
    description String?     @db.Text
    discountType DiscountType     @default(FIXED_AMOUNT)
    discountValue Float   @db.DoublePrecision @default(0)
    validFrom   DateTime
    validTo     DateTime
    usageLimit  Int?     @db.Integer
    timesUsed   Int         @default(0) @db.Integer
    isActive    Boolean     @default(true) @db.Boolean
    createdAt   DateTime    @default(now())
    user        User        @relation(fields: [createdBy], references: [id], onDelete: Restrict, onUpdate: Cascade)
    createdBy   BigInt     @db.BigInt
    updatedAt   DateTime    @updatedAt
    userVouchers UserVouchers[]
    voucherForProduct Products[]
    voucherForCategory Category[]
    voucherForSpecialProductVariant ProductVariants[]

    @@index([createdBy], name: "idx_voucher_created_by_user_id")
}

model UserVouchers {
    id          BigInt      @db.BigInt @id @default(autoincrement())
    user        User        @relation(fields: [userId], references: [id], onDelete: Cascade, onUpdate: Cascade)
    userId      BigInt      @db.BigInt
    voucher     Vouchers    @relation(fields: [voucherId], references: [id], onDelete: Cascade, onUpdate: Cascade)
    voucherId   BigInt      @db.BigInt
    useVoucherAt  DateTime?
    saveVoucherAt   DateTime    @default(now())
    voucherStatus VoucherStatus      @default(SAVED)
    createdAt   DateTime    @default(now())
    updatedAt   DateTime    @updatedAt

    @@index([userId], name: "idx_userVoucher_user_id")
    @@index([voucherId], name: "idx_userVoucher_voucher_id")
}

model Requests {
    id          BigInt      @db.BigInt @id @default(autoincrement())
    user        User        @relation(fields: [userId], references: [id], onDelete: Restrict, onUpdate: Cascade)
    userId      BigInt      @db.BigInt
    processByStaff        User?        @relation("RequestsProcessedByStaff", fields: [processByStaffId], references: [id], onDelete: Restrict, onUpdate: Cascade)
    processByStaffId      BigInt?      @db.BigInt
    order       Orders      @relation(fields: [orderId], references: [id], onDelete: Restrict, onUpdate: Cascade)
    orderId     BigInt      @db.BigInt
    subject     String      @db.VarChar(255)
    description String      @db.Text
    status      RequestStatus      @default(PENDING)
    createdAt   DateTime    @default(now())
    updatedAt   DateTime    @updatedAt
    returnRequest ReturnRequests[]
    media       Media[]

    @@index([userId], name: "idx_request_user_id")
    @@index([processByStaffId], name: "idx_request_processed_by_staff_id")
    @@index([orderId], name: "idx_request_order_id")
}

model ReturnRequests {
    id          BigInt      @db.BigInt @id @default(autoincrement())
    request     Requests    @relation(fields: [requestId], references: [id], onDelete: Restrict, onUpdate: Cascade)
    requestId   BigInt      @db.BigInt @unique
    bankName    String      @db.VarChar(100)
    bankAccountNumber String @db.VarChar(50) 
    createdAt   DateTime    @default(now())
    updatedAt   DateTime    @updatedAt

    @@index([requestId], name: "idx_returnRequest_request_id")
}
